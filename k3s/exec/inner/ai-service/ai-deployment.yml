apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-service
  namespace: flowin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-service
  template:
    metadata:
      labels:
        app: ai-service
    spec:
      # [추가] 메인 컨테이너(ai-service)가 실행되기 전 실행되는 초기화 컨테이너
      initContainers:
        - name: ensure-collection
          image: curlimages/curl
          command:
            - sh
            - -c
            - |
              # ChromaDB가 완전히 응답할 때까지 대기 후, 컬렉션을 직접 생성 시도
              until curl -s http://chroma-service:8000/api/v1/heartbeat; do
                echo "Waiting for ChromaDB Heartbeat"
                sleep 2
              done
              
              echo "ChromaDB is up, Creating collection if not exists"
              curl -X POST http://chroma-service:8000/api/v1/collections \
                   -H "Content-Type: application/json" \
                   -d '{"name": "SpringAiCollection", "get_or_create": true}'
              
              echo "Collection is ready."

      containers:
        - name: ai-service
          image: kkoj/ai-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8500

          env:

            # 힙 메모리 강제 고정(-Xmx)을 해제하여 JVM의 컨테이너 자동 인식(Ergonomics) 활용
            - name: JAVA_TOOL_OPTIONS
              value: "-Dserver.port=8500"

            # Spring Boot 완화된 바인딩(Relaxed Binding) 규칙에 맞춘 환경 변수명
            - name: SPRING_AI_VECTORSTORE_CHROMA_CLIENT_HOST
              value: "http://chroma-service"
            - name: SPRING_AI_VECTORSTORE_CHROMA_CLIENT_PORT
              value: "8000"
            - name: SPRING_AI_VECTORSTORE_CHROMA_INITIALIZE_SCHEMA
              value: "true"

            - name: AI_SERVICE_OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ai-secret
                  key: AI_SERVICE_OPENAI_API_KEY

          # 앱이 완전히 뜰 때까지 쿠버네티스가 기다려주게 만듭니다.
          livenessProbe:
            tcpSocket:
              port: 8500
            initialDelaySeconds: 120 # 앱 기동 후 2분 동안은 살아 있음
            periodSeconds: 20
          readinessProbe:
            tcpSocket:
              port: 8500
            initialDelaySeconds: 60
            periodSeconds: 10

          # [중요] 일반 API 서비스(512Mi) 대비 2배의 넉넉한 메모리 한도 부여
          resources:
            requests:
              memory: "512Mi"
            limits:
              memory: "1Gi"