apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-service
  namespace: flowin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-service
  template:
    metadata:
      labels:
        app: ai-service
    spec:
      containers:
        - name: ai-service
          image: kkoj/ai-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8500

          env:

            # 힙 메모리 강제 고정(-Xmx)을 해제하여 JVM의 컨테이너 자동 인식(Ergonomics) 활용
            - name: JAVA_TOOL_OPTIONS
              value: "-Dserver.port=8500"

            # Spring Boot 완화된 바인딩(Relaxed Binding) 규칙에 맞춘 환경 변수명
            - name: SPRING_AI_VECTORSTORE_CHROMA_CLIENT_HOST
              value: "http://chroma-service.flowin.svc.cluster.local"
            - name: SPRING_AI_VECTORSTORE_CHROMA_CLIENT_PORT
              value: "8000"
            - name: SPRING_AI_VECTORSTORE_CHROMA_INITIALIZE_SCHEMA
              value: "true"

            - name: AI_SERVICE_OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ai-secret
                  key: AI_SERVICE_OPENAI_API_KEY

          # [중요] 일반 API 서비스(512Mi) 대비 2배의 넉넉한 메모리 한도 부여
          resources:
            requests:
              memory: "512Mi"
            limits:
              memory: "1Gi"